#!/usr/bin/env ruby
require 'csi'
require 'pry'
require 'rainbow'

begin
  pry_obj = Pry

  #csi_command_set = Pry::CommandSet.new do
  #  command("toggle-pager") do
  #    if _pry_.config.pager
  #      _pry_.config.pager = false
  #    else
  #      _pry_.config.pager = true
  #    end
  #  end
  #end

  csi_command_set = pry_obj::Commands.instance_eval do
    command("toggle-pager", "") do
      if _pry_.config.pager
        _pry_.config.pager = false
      else
        _pry_.config.pager = true
      end
    end
  end

  line = ->(pry) { pry.input_array.size }
  prompt_arrow = Rainbow("\u00bb").green.to_s.scrub
  pry_obj.config.prompt = [ 
    ->(object, level, pry) do 
      "#{Rainbow("csi").red.bright}[v#{CSI::VERSION}]:#{line.(pry)} #{prompt_arrow} \e[0m"
    end, ->(object, level, pry) do
       "#{Rainbow("csi").red.bright}[v#{CSI::VERSION}]:#{line.(pry)} * \e[0m"
    end
  ]
  puts binding
  pry_obj.start(binding, :commands => csi_command_set)
ensure
  if $browser
    $browser = CSI::Plugins::TransparentBrowser.close(
      :browser_obj => $browser
    )
  end
end
