#!/usr/bin/env ruby
require 'csi'
require 'pry'
require 'rainbow'

begin
  module CSISession
    refine Pry do 
      class Command::TogglePager < Pry::ClassCommand
        match 'toggle-pager'
        group 'Misc'
        description 'Toggle session pager.'

        banner <<-'BANNER'
          Usage: toggle-pager

          Toggle sesion pager.
        BANNER
      
        def process
          _pry_.config.pager = pager_toggle
          output.puts "Session pager #{_pry_.config.pager ? "on":"off"}"
        end

        def pager_toggle
          !_pry_.config.pager
        end
      end
    end
  end

  using CSISession
  line = ->(pry) { pry.input_array.size }
  prompt_arrow = Rainbow("\u00bb").green
  pry_obj = Pry
  pry_obj.config.prompt = [ 
    ->(object, level, pry) do 
      "#{Rainbow("csi").red.bright}[v#{CSI::VERSION}]:#{line.(pry)} #{prompt_arrow} \e[0m"
    end, ->(object, level, pry) do
       "#{Rainbow("csi").red.bright}[v#{CSI::VERSION}]:#{line.(pry)} * \e[0m"
    end
  ]
  pry_obj.start
ensure
  if $browser
    $browser = CSI::Plugins::TransparentBrowser.close(
      :browser_obj => $browser
    )
  end
end
