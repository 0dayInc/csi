#!/usr/bin/env ruby
require 'csi'
require 'aws-sdk'
require 'optparse'
require 'yaml'

opts = {}
OptionParser.new do |options|
  options.banner = %Q{USAGE:
    #{$0} [opts]
  }

  options.on("-rREGION", "--region=REGION", "<Required - Region to Describe>") do |region| 
    opts[:region] = region
  end

  options.on("-cYAML", "--aws_yaml=YAML", "<Quickest - Path to YAML Config>") do |yaml| 
    opts[:yaml] = yaml
  end

  options.on("-AAKI", "--access_key_id=AKI", "<Alternative over Quickest - AWS Access Key ID>") do |aki| 
    opts[:aki] = aki
  end

  options.on("-SSAK", "--secret_access_key=SAK", "<Alternative over Quickest - Secret Access Key>") do |sak| 
    opts[:sak] = sak
  end

  options.on("-aARN", "--sts_role_arn=ARN", "<More Secure than Quickest or Alt - STS Role ARN>") do |sts_role_arn| 
    opts[:sts_role_arn] = sts_role_arn
  end

  options.on("-nRNAME", "--sts_role_name=RNAME", "<More Secure than Quickest or Alt - STS Role Name>") do |sts_role_name| 
    opts[:sts_role_name] = sts_role_name
  end

  options.on("-eEXPIRES", "--sts_expiration=EXPIRES", "<More Secure than Quickest or Alt - STS Expiration (Defaults to 900 Seconds)>") do |sts_exp| 
    opts[:sts_exp] = sts_exp
  end

end.parse!

if opts.empty?
  puts `#{$0} --help`
  exit 1
end 

logger = CSI::Plugins::CSILogger.create()

if opts[:yaml]
  yaml = YAML.load_file(opts[:yaml]) if File.exists?(opts[:yaml])
  access_key_id = yaml["access_key_id"].to_s.scrub.strip.chomp
  secret_access_key = yaml["secret_access_key"].to_s.scrub.strip.chomp
else
  access_key_id = opts[:aki].to_s.scrub
  secret_access_key = opts[:sak].to_s.scrub
end

region = opts[:region].to_s.scrub
sts_role_arn = opts[:sts_role_arn].to_s.scrub
sts_role_name = opts[:sts_role_name].to_s.scrub

if opts[:sts_exp].nil?
  sts_exp = 900
else
  sts_exp = opts[:sts_exp].to_i
end

if access_key_id == "" && secret_access_key == "" 
  credentials = CSI::Plugins::AWSSTS.get_temp_credentials(
    :region => region,
    :role_arn => sts_role_arn,
    :role_session_name => sts_role_name,
    :duration_seconds => sts_exp
  )
else
  credentials = Aws::Credentials.new(access_key_id, secret_access_key)
end

# BEGIN Describing Region ***
api_gateway_obj = CSI::Plugins::AWSAPIGateway.connect(
  :region => region, 
  :access_key_id => credentials.access_key_id, 
  :secret_access_key => credentials.secret_access_key, 
  :sts_session_token => credentials.session_token
)
#puts api_gateway_obj.public_methods
CSI::Plugins::AWSAPIGateway.disconnect(:api_gateway_obj => api_gateway_obj)

app_auto_scale_obj = CSI::Plugins::AWSApplicationAutoScaling.connect(
  :region => region, 
  :access_key_id => credentials.access_key_id, 
  :secret_access_key => credentials.secret_access_key, 
  :sts_session_token => credentials.session_token
)
#puts app_auto_scale_obj.public_methods
CSI::Plugins::AWSApplicationAutoScaling.disconnect(:app_auto_scale_obj => app_auto_scale_obj)

app_discover_svc_obj = CSI::Plugins::AWSApplicationDiscoveryService.connect(
  :region => region, 
  :access_key_id => credentials.access_key_id, 
  :secret_access_key => credentials.secret_access_key, 
  :sts_session_token => credentials.session_token
)
#puts app_auto_scale_obj.public_methods
CSI::Plugins::AWSApplicationDiscoveryService.disconnect(:app_discover_svc_obj => app_discover_svc_obj)

auto_scaling_obj = CSI::Plugins::AWSAutoScaling.connect(
  :region => region, 
  :access_key_id => credentials.access_key_id, 
  :secret_access_key => credentials.secret_access_key, 
  :sts_session_token => credentials.session_token
)
#puts app_auto_scale_obj.public_methods
CSI::Plugins::AWSAutoScaling.disconnect(:auto_scaling_obj => auto_scaling_obj)

#:AWSCloudFormation,
#:AWSCloudFront,
#:AWSCloudHSM,
#:AWSCloudSearch,
#:AWSCloudSearchDomain,
#:AWSCloudTrail,
#:AWSCloudWatch,
#:AWSCloudWatchEvents,
#:AWSCloudWatchLogs,
#:AWSCodeCommit,
#:AWSCodeDeploy,
#:AWSCodePipeline,
#:AWSCognitoIdentity,
#:AWSCognitoIdentityProvider,
#:AWSCognitoSync,
#:AWSConfigService,
#:AWSDataPipeline,
#:AWSDatabaseMigrationService,
#:AWSDeviceFarm,
#:AWSDirectConnect,
#:AWSDirectoryService,
#:AWSDynamoDB,
#:AWSDynamoDBStreams,

ec2_obj = CSI::Plugins::AWSEC2.connect(
  :region => region, 
  :access_key_id => credentials.access_key_id, 
  :secret_access_key => credentials.secret_access_key, 
  :sts_session_token => credentials.session_token
)
#puts ec2_obj.public_methods
CSI::Plugins::AWSEC2.disconnect(:ec2_obj => ec2_obj)

# :AWSECR,
# :AWSECS,
# :AWSEFS,
# :AWSEMR,
# :AWSElastiCache,

eb_obj = CSI::Plugins::AWSElasticBeanstalk.connect(
  :region => region, 
  :access_key_id => credentials.access_key_id, 
  :secret_access_key => credentials.secret_access_key, 
  :sts_session_token => credentials.session_token
)
#puts eb_obj.public_methods
CSI::Plugins::AWSElasticBeanstalk.disconnect(:eb_obj => eb_obj)

#:AWSElasticLoadBalancing,
#:AWSElasticLoadBalancingV2,
#:AWSElasticTranscoder,
#:AWSElasticsearchService,
#:AWSFirehose,
#:AWSGameLift,
#:AWSGlacier,
#:AWSIAM,
#:AWSImportExport,
#:AWSInspector,
#:AWSIoT,
#:AWSIoTDataPlane,
#:AWSKMS,
#:AWSKinesis,
#:AWSKinesisAnalytics,

lambda_obj = CSI::Plugins::AWSLambda.connect(
  :region => region, 
  :access_key_id => credentials.access_key_id, 
  :secret_access_key => credentials.secret_access_key, 
  :sts_session_token => credentials.session_token
)
#puts lambda_obj.public_methods
CSI::Plugins::AWSLambda.disconnect(:lambda_obj => lambda_obj)

#:AWSLambdaPreview,
#:AWSMachineLearning,
#:AWSMarketplaceCommerceAnalytics,
#:AWSMarketplaceMetering,
#:AWSOpsWorks,
#:AWSRDS,
#:AWSRedshift,
#:AWSRoute53,
#:AWSRoute53Domains,

s3_obj = CSI::Plugins::AWSS3.connect(
  :region => region, 
  :access_key_id => credentials.access_key_id, 
  :secret_access_key => credentials.secret_access_key, 
  :sts_session_token => credentials.session_token
)
#puts s3_obj.public_methods
CSI::Plugins::AWSS3.disconnect(:s3_obj => s3_obj)

#:AWSSES,
#:AWSSNS,
#:AWSSQS,
#:AWSSSM,
#:AWSSTS,
#:AWSSWF,
#:AWSServiceCatalog,
#:AWSSimpleDB,
#:AWSSnowball,
#:AWSStorageGateway,
#:AWSSupport,
#:AWSWAF,
#:AWSWorkspaces
