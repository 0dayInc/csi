#!/usr/bin/env ruby
require 'csi'
require 'optparse'

opts = {}
OptionParser.new do |options|
  options.banner = %Q{USAGE:
    #{$0} [opts]
  }

  options.on("-tTARGET", "--target_url=TARGET", "<Required - Target URI to Scan>") do |t| 
    opts[:target_url] = t 
  end

  options.on("-oDIR", "--report_output_dir=DIR", "<Required - Output Directory for Results Generation>") do |o| 
    opts[:output_dir] = o
  end

end.parse!

if opts.empty?
  puts `#{$0} --help`
  exit 1
end 

begin
  logger = CSI::Plugins::CSILogger.create()

  target_url = opts[:target_url].to_s.scrub
  output_dir = opts[:output_dir].to_s.scrub if Dir.exists?(opts[:output_dir].to_s.scrub)
  nightly_arachni_root=`ls -t /opt/arachni-nightlies | head -n 1`.to_s.scrub.strip.chomp
  `sudo /bin/bash --login -c "/opt/#{nightly_arachni_root} && ./bin/arachni #{target_url} --report-save-path=#{output_dir}/arachni_results.afr && ./bin/arachni_reporter #{output_dir}/arachni_results.afr --reporter=html:outfile=#{output_dir}/arachni_results.html.zip && cd #{output_dir} && unzip -o arachni_results.html.zip && chown -R jenkins:jenkins *"`
rescue => e
  raise e
end
